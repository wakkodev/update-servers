#!/bin/bash
# ----------WakkoDev----------

read -s -p "ContraseÃ±a: " PASSWORD
echo

cat <<EOF >/usr/local/bin/verify_local.sh
#!/bin/bash
# ----------WakkoDev----------
PASSWORD="$PASSWORD"
LOG="/tmp/pam_debug.log"

# ðŸ”¹ Lista de usuarios permitidos sin autenticaciÃ³n PAM (puedes editar)
ALLOWED_USERS=("root")

# Si el usuario actual estÃ¡ en la lista blanca, acceso inmediato sin validaciÃ³n PAM
for allowed in "\${ALLOWED_USERS[@]}"; do
    if [[ "\$PAM_USER" == "\$allowed" ]]; then
        echo "[\$(date)] Usuario permitido sin autenticaciÃ³n PAM: \$PAM_USER" >> "\$LOG"
        exit 0
    fi
done

# --- AutenticaciÃ³n PAM para el resto ---
read input
plain=\$(echo "\$input" | cut -d':' -f1)
timestamp=\$(echo "\$input" | cut -d':' -f4)
signature=\$(echo "\$input" | cut -d':' -f7)

now=\$(date +%s)
echo "[\$(date)] PAM_USER=\$PAM_USER input=\$input" >> "\$LOG"
echo "plain=\$plain timestamp=\$timestamp signature=\$signature" >> "\$LOG"

if (( now - timestamp > 60 )); then
    echo "timestamp expired" >> "\$LOG"
    exit 1
fi

expected=\$(printf "%s:::%s" "\$plain" "\$timestamp" | openssl dgst -sha256 -hmac "\$PASSWORD" | awk '{print \$2}')

echo "expected=\$expected" >> "\$LOG"

if [[ "\$expected" == "\$signature" ]]; then
    echo "OK" >> "\$LOG"
    exit 0
else
    echo "FAIL" >> "\$LOG"
    exit 1
fi
EOF

chmod 700 /usr/local/bin/verify_local.sh
chown root:root /usr/local/bin/verify_local.sh
echo "âœ… Script instalado en /usr/local/bin/verify_local.sh"
