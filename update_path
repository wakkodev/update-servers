#!/bin/bash

CONFIG_FILE="/etc/v2ray/config.json"
PATH_LIST="/root/path"
TEMP_FILE="/tmp/config.json.tmp"
STATE_FILE="/etc/v2ray/last_path_index.dat"

# Verificar existencia del archivo de paths
if [[ ! -f "$PATH_LIST" ]]; then
    echo "❌ El archivo path no existe"
    exit 1
fi

# Leer todos los paths en un array
mapfile -t paths < "$PATH_LIST"
total_paths=${#paths[@]}

if (( total_paths == 0 )); then
    echo "❌ El archivo path está vacío"
    exit 1
fi

# Leer el índice anterior del archivo o empezar desde -1
if [[ -f "$STATE_FILE" ]]; then
    last_index=$(<"$STATE_FILE")
else
    last_index=-1
fi

# Calcular el nuevo índice (cíclico)
next_index=$(( (last_index + 1) % total_paths ))
NEW_PATH="${paths[$next_index]}"

# Guardar el nuevo índice
echo "$next_index" > "$STATE_FILE"

# Aplicar el nuevo path en el archivo JSON usando jq
jq --arg newPath "$NEW_PATH" '
(.inbounds[]?.streamSettings?.wsSettings?.path) |= $newPath
' "$CONFIG_FILE" > "$TEMP_FILE" && mv "$TEMP_FILE" "$CONFIG_FILE"

# Reiniciar V2Ray para aplicar cambios
systemctl restart v2ray

echo "✅ Nuevo path aplicado: $NEW_PATH"
