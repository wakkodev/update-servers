#!/bin/bash
# ----------WakkoDev----------

read -p "Usuario: " USER
read -s -p "Contraseña: " PASSWORD
echo

cat <<EOF >/usr/local/bin/verify_local.sh
#!/bin/bash
# ----------WakkoDev----------
USER="$USER"
PASSWORD="$PASSWORD"
LOG="/tmp/pam_debug.log"

if [[ "\$PAM_USER" != "\$USER" ]]; then
    exit 0
fi

read input
plain=\$(echo "\$input" | cut -d':' -f1)
timestamp=\$(echo "\$input" | cut -d':' -f4)
signature=\$(echo "\$input" | cut -d':' -f7)

now=\$(date +%s)
echo "[\$(date)] PAM_USER=\$PAM_USER input=\$input" >> "\$LOG"
echo "plain=\$plain timestamp=\$timestamp signature=\$signature" >> "\$LOG"

if (( now - timestamp > 60 )); then
    echo "timestamp expired" >> "\$LOG"
    exit 1
fi

expected=\$(printf "%s:::%s" "\$plain" "\$timestamp" | openssl dgst -sha256 -hmac "\$PASSWORD" | awk '{print \$2}')

echo "expected=\$expected" >> "\$LOG"

if [[ "\$expected" == "\$signature" ]]; then
    echo "OK" >> "\$LOG"
    exit 0
else
    echo "FAIL" >> "\$LOG"
    exit 1
fi
EOF

chmod 700 /usr/local/bin/verify_local.sh
chown root:root /usr/local/bin/verify_local.sh
echo "✅ Script instalado en /usr/local/bin/verify_local.sh"
