#!/bin/bash

# Verifica si se ejecuta como root
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå Este script debe ejecutarse como root"
  exit 1
fi

# Solicita el nombre de usuario
read -p "üë§ Nombre del usuario a configurar OTP: " USUARIO

# Obtiene el home del usuario
USER_HOME=$(eval echo "~$USUARIO")

# Crea el home si no existe
if [ ! -d "$USER_HOME" ]; then
  echo "üìÅ El directorio $USER_HOME no existe. Cre√°ndolo..."
  mkdir -p "$USER_HOME"
  chown "$USUARIO:$USUARIO" "$USER_HOME"
fi

# Verifica si google-authenticator est√° instalado
if ! command -v google-authenticator &> /dev/null; then
  echo "‚ö†Ô∏è No se encontr√≥ google-authenticator. Instalando..."
  apt update && apt install -y libpam-google-authenticator
fi

# Ruta del archivo OTP
OTP_FILE="$USER_HOME/.google_authenticator"

# Genera el secreto OTP
echo "üîê Generando clave secreta para $USUARIO..."
google-authenticator -s "$OTP_FILE" -t -d -f -r 3 -R 30 -W -l "$USUARIO@$(hostname)" > /dev/null

# Establece los permisos correctos
chown "$USUARIO:$USUARIO" "$OTP_FILE"
chmod 400 "$OTP_FILE"

echo "‚úÖ OTP configurado exitosamente para $USUARIO"
echo "üìç Ahora escanea el c√≥digo QR o agrega la clave manualmente desde el archivo:"
echo "    $OTP_FILE"
